name: Performance Benchmark

on: [workflow_dispatch]  # 手动触发

jobs:
  benchmark:
    runs-on: ubuntu-latest  # 使用最新版 Ubuntu 运行器

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: System Information
      run: |
        echo "===== CPU Info ====="
        lscpu
        echo "===== Memory Info ====="
        free -h
        echo "===== Disk Speed ====="
        dd if=/dev/zero of=./testfile bs=1G count=1 oflag=direct
        echo "===== Kernel Version ====="
        uname -a

    - name: Install Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y bc gcc make libssl-dev flex bison libelf-dev

    - name: Download Linux Kernel
      run: |
        wget https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-6.5.tar.xz
        tar -xf linux-6.5.tar.xz
        cd linux-6.5

    - name: Configure Kernel (Minimal)
      run: |
        make defconfig  # 使用默认配置减少编译时间
        ./scripts/config --disable DEBUG_INFO  # 禁用调试信息以节省空间和时间

    - name: Build Kernel (Timed)
      run: |
        echo "===== Starting Kernel Build ====="
        time make -j$(nproc)  # 使用全部可用核心编译
        echo "===== Build Finished ====="

    - name: Stress Test (Optional)
      run: |
        sudo apt-get install -y stress-ng
        stress-ng --cpu $(nproc) --vm 1 --vm-bytes 2G --timeout 5m