name: Kernel Build Benchmark

on:
  workflow_dispatch:  # æ‰‹åŠ¨è§¦å‘
  schedule:
    - cron: '0 0 * * 0'  # æ¯å‘¨è‡ªåŠ¨è¿è¡Œï¼ˆå¯é€‰ï¼‰

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6å°æ—¶è¶…æ—¶
    env:
      DEBIAN_FRONTEND: noninteractive

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Free Disk Space
      run: |
        # æ¸…ç†é¢„è£…å†…å®¹é‡Šæ”¾ç©ºé—´
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /usr/local/lib/android
        df -h

    - name: Run Benchmark
      run: |
        cat << 'EOF' > benchmark.sh
        #!/bin/bash
        set -eo pipefail
        
        # ç²¾ç®€ç‰ˆä¾èµ–å®‰è£…
        install_deps() {
          sudo apt-get update -qq
          sudo apt-get install -y --no-install-recommends \
            build-essential git time sysbench fio bc \
            libssl-dev flex bison libelf-dev mbw
        }

        # ä¼˜åŒ–ç‰ˆå†…æ ¸ç¼–è¯‘æµ‹è¯•
        compile_kernel() {
          git clone --depth 1 --branch v6.6 \
            https://git.kernel.org/pub/scm/linux/kernel/git/stable/linux.git
          cd linux
          make localmodconfig  # æ›´å°é…ç½®
          time make -j$(nproc)
          make clean
        }

        # æ ¸å¿ƒæµ‹è¯•æµç¨‹
        main() {
          echo "ğŸŸ¢ å¼€å§‹åŸºå‡†æµ‹è¯• @ $(date)"
          echo "=== CPUæµ‹è¯• ==="
          sysbench cpu --threads=$(nproc) run | grep 'events per second'
          
          echo "=== å†…å­˜æµ‹è¯• ==="
          mbw -q 256 | grep AVG

          echo "=== ç£ç›˜æµ‹è¯• ==="
          fio --name=seqwrite --rw=write --bs=1M --size=500M --runtime=10s \
            --end_fsync=1 --output-format=json | jq '.jobs[0].write.bw/1024 | floor' | awk '{print $1"MB/s"}'
          
          echo "=== å†…æ ¸ç¼–è¯‘ ==="
          compile_kernel
        }

        # é”™è¯¯å¤„ç†
        trap 'echo "âŒ é”™è¯¯å‘ç”Ÿåœ¨ç¬¬ $LINENO è¡Œ"; exit 1' ERR
        install_deps
        main
        EOF

        chmod +x benchmark.sh
        ./benchmark.sh 2>&1 | tee benchmark.log

    - name: Upload Results
      uses: actions/upload-artifact@v3
      with:
        name: benchmark-results
        path: |
          benchmark.log
          linux/.config  # ä¿ç•™é…ç½®æ–‡ä»¶
